<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>three.js - pointerlock controls</title>

		</style>
	</head>
	<body>

		<script src="https://rawgithub.com/mrdoob/three.js/master/build/three.min.js"></script>
		<script src="http://homepages.ecs.vuw.ac.nz/~saxondavi/js/MTLLoader.js"></script>
		<script src="http://homepages.ecs.vuw.ac.nz/~saxondavi/js/OBJMTLLoader.js"></script>
		<script src="http://homepages.ecs.vuw.ac.nz/~saxondavi/js/OBJLoader.js"></script>
		<script src="http://homepages.ecs.vuw.ac.nz/~markovmadd/MyPointerLockControls.js"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
		<script type="text/javascript" src="http://homepages.ecs.vuw.ac.nz/~markovmadd/interactions.js"></script>
		<link href='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css' rel='stylesheet' type='text/css'>
		<link href='http://homepages.ecs.vuw.ac.nz/~markovmadd/stylesheet.css' rel='stylesheet' type='text/css'>

		<div id="blocker">

			<div id="instructions">
				<span style="font-size:40px">Click to play</span>
				<br />
				(W, A, S, D = Move, SPACE = Jump, MOUSE = Look around, Q = Interact, T = Talk)
			<div id="fb-root"></div>
	    		<div class="fb-login-button" autologoutlink="true" scope="publish_stream" data-show-faces="false" data-width="200" data-max-rows="1"></div>
			</div>

		</div>

					<!-- Leave this div, it is for showing toggle boxes work -Maddy -->
		<div id="windmills-stuff">
		<!--<span style="font-size:40px">Hi!</span>-->
		<div id="windmills-slider"></div>
		<div id="windmills">Windmills: 50</div>
		</div>
		<div id="insulation-stuff">
		<div id="insulation-slider"></div>
		<div id="insulation">Insulation: 50</div>
		</div>
		<div id="cars-stuff">
		<div id="cars-slider"></div>
		<div id="cars">Cars: 50</div>
		</div>

		<!--<div id="dialogue-box"> -->
		    <div id="dialogue-text">Welcome to our town.</div>
		<!--</div>-->


		<script>
		/*	document.getElementById("insulation").style.visibility = "hidden";
			document.getElementById("cars").style.visibility = "hidden";*/
			var numWindmills = 50;		
			var insulationAmt = 50;	
			var carEfficiency = 50;
			var toggle = false;	
			var dialogue = false;

			var camera, scene, renderer;
			var geometry, material, mesh;
			var controls,time = Date.now();

			var objects = [];

			var blades = [];
			var blade_speed = [];

			var ray;

			var blocker = document.getElementById( 'blocker' );
			var instructions = document.getElementById( 'instructions' );

			//dude scales
			var dude_scales = [];
			//dude rotations
			var dude_rotations = [];
			//dude positions
			var dude_positions_x = [];
			var dude_positions_y = [];
			var dude_positions_z = [];

			//windmill scale
			var windmill_scale = 40;
			//windmill positions
			var windmill_positions_x = [];
			var windmill_positions_y = [];
			var windmill_positions_z = [];

			//house 1 scale
			var house_1_scale = 20;
			//house 1 rotations
			var house_1_rotations = [];
			//house 1 positions
			var house_1_positions_x = [];
			var house_1_positions_y = [];
			var house_1_positions_z = [];

			var water; // THREE.geometry object
			var seaLevel = -50;


			// http://www.html5rocks.com/en/tutorials/pointerlock/intro/

			var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

			if ( havePointerLock ) {

				var element = document.body;

				var pointerlockchange = function ( event ) {

					if ( document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element ) {

						controls.enabled = true;

						blocker.style.display = 'none';

					} else {

						controls.enabled = false;

						blocker.style.display = '-webkit-box';
						blocker.style.display = '-moz-box';
						blocker.style.display = 'box';

						instructions.style.display = '';

					}

				}

				var pointerlockerror = function ( event ) {

					instructions.style.display = '';

				}

				// Hook pointer lock state change events
				document.addEventListener( 'pointerlockchange', pointerlockchange, false );
				document.addEventListener( 'mozpointerlockchange', pointerlockchange, false );
				document.addEventListener( 'webkitpointerlockchange', pointerlockchange, false );

				document.addEventListener( 'pointerlockerror', pointerlockerror, false );
				document.addEventListener( 'mozpointerlockerror', pointerlockerror, false );
				document.addEventListener( 'webkitpointerlockerror', pointerlockerror, false );

				instructions.addEventListener( 'click', function ( event ) {

					instructions.style.display = 'none';

					// Ask the browser to lock the pointer
					element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

					if ( /Firefox/i.test( navigator.userAgent ) ) {

						var fullscreenchange = function ( event ) {

							if ( document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element ) {

								document.removeEventListener( 'fullscreenchange', fullscreenchange );
								document.removeEventListener( 'mozfullscreenchange', fullscreenchange );

								element.requestPointerLock();
							}

						}

						document.addEventListener( 'fullscreenchange', fullscreenchange, false );
						document.addEventListener( 'mozfullscreenchange', fullscreenchange, false );

						element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

						element.requestFullscreen();

					} else {

						element.requestPointerLock();

					}

				}, false );

			} else {

				instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

			}

			// NOTE: animate() was moved to be inside the init() function to fix the error that
			// where water isn't loaded in animate yet
			init();

			function init() {
				initInteractions(); //Call to interactions.js library (located in js if you want to modify it, but hosted on my homepages
							  //currently -Maddy

				//$( "#dialogue-box").toggle("fold");

				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1000 );

				scene = new THREE.Scene();
				scene.fog = new THREE.Fog( 0xffffff, 0, 1500 );

				var light = new THREE.DirectionalLight( 0xffffff, 1.5 );
				light.position.set( 1, 1, 1 );
				scene.add( light );

				var light = new THREE.DirectionalLight( 0x88aaaa, 0.75 );
				light.position.set( -1, - 0.5, -1 );
				scene.add( light );

				controls = new THREE.PointerLockControls( camera );
				scene.add( controls.getObject() );

				ray = new THREE.Raycaster();
				ray.ray.direction.set( 0, -1, 0 );

				// sea
				 var loader = new THREE.ImageLoader( );
                loader.load( 'http://homepages.ecs.vuw.ac.nz/~remnanjona/M.A.F.I.A/res/water.jpg', function ( image ) {

                	var texture = new THREE.Texture();
                    texture.image = image;
                    texture.needsUpdate = true;

                   	geometry = new THREE.PlaneGeometry( 2000, 2000, 100, 100 );
					geometry.applyMatrix( new THREE.Matrix4().makeRotationX( - Math.PI / 2 ) );

					for ( var i = 0, l = geometry.vertices.length; i < l; i ++ ) {

						var vertex = geometry.vertices[ i ];
						vertex.x += Math.random() * 20 - 10;
						vertex.y += Math.random() * 5;
						vertex.z += Math.random() * 20 - 10;

					}

                    material  = new THREE.MeshLambertMaterial({
  						map           : texture,
 						vertexColors  : THREE.VertexColors,
 						transparent: true, 
 						opacity: 0.9
 					} );

 					water = new THREE.Mesh( geometry, material );
					scene.add( water );

					animate();
			
				});

                //TERRAIN
                createTerrain();

                //DUDE
                initDudePositions();
                createDude();

                //WINDMILL
                initWindmillPositions();
                createWindmills();

            	//HOUSE
            	initHouse1Positions();
            	createHouse1();


				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.setClearColorHex( 0xaaffff, 1 );

				document.body.appendChild( renderer.domElement );


				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );

				//

				controls.isOnObject( false );

				ray.ray.origin.copy( controls.getObject().position );
				ray.ray.origin.y -= 10;

				var intersections = ray.intersectObjects( objects );

				if ( intersections.length > 0 ) {

					var distance = intersections[ 0 ].distance;

					if ( distance > 0 && distance < 10 ) {

						controls.isOnObject( true );

					}

				}

				// rotate all the blades
				for (var i = 0; i < blades.length; i++) {
					blades[i].rotation.z += blade_speed[i];
				}

				// update sea level
				water.position.y = seaLevel;
				seaLevel += 0.01;

				controls.update( Date.now() - time );
				if(toggle){
					$( "#test" ).toggle( "fold" );
					toggle = false;
				}
				if(dialogue){
					console.log("Should display dialogue box");
					$( "#dialogue-box" ).toggle( "fold" );
					dialogue = false;
				}
				renderer.render( scene, camera );


				time = Date.now();

			}



			//creates the terrain
			function createTerrain() {

        	var loadermtl = new THREE.OBJMTLLoader();

                //terrain
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/terrain/terrain.obj',
	 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/terrain/terrain.mtl', 
	 				function ( object ) {

 					scene.add( object );
                	objects.push( object );
				});
			}

			function initDudePositions() {

				dude_scales.push(12);
				dude_rotations.push(0);
				dude_positions_x.push(0.0);
				dude_positions_y.push(0.0);
				dude_positions_z.push(-140.0);

				dude_scales.push(7);
				dude_rotations.push(0);
				dude_positions_x.push(20.0);
				dude_positions_y.push(5.0);
				dude_positions_z.push(-160.0);
				dude_scales.push(10);
				dude_rotations.push(0);
				dude_positions_x.push(30.0);
				dude_positions_y.push(5.0);
				dude_positions_z.push(-160.0);
			}

			function createDude() {

            	var loadermtl = new THREE.OBJMTLLoader();
	
                //eyes
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_eyes.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_eyes.mtl',
				 				function ( object ) {

 					for (var i = 0; i < dude_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(dude_scales[i], dude_scales[i], dude_scales[i]);
	            		mesh.rotation.y = dude_rotations[i];
	            		mesh.position.x = dude_positions_x[i];;
						mesh.position.y = dude_positions_y[i];
						mesh.position.z = dude_positions_z[i];

	                	scene.add(mesh);
	                	objects.push(mesh);
                	}
				});

            	//face
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_face.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_face.mtl',
				 				function ( object ) {

 					for (var i = 0; i < dude_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(dude_scales[i], dude_scales[i], dude_scales[i]);
	            		mesh.rotation.y = dude_rotations[i];
	            		mesh.position.x = dude_positions_x[i];;
						mesh.position.y = dude_positions_y[i];
						mesh.position.z = dude_positions_z[i];

	                	scene.add(mesh);
	                	objects.push(mesh);
                	}
				});

            	//top
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_top.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_top.mtl',
				 				function ( object ) {

 					for (var i = 0; i < dude_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(dude_scales[i], dude_scales[i], dude_scales[i]);
	            		mesh.rotation.y = dude_rotations[i];
	            		mesh.position.x = dude_positions_x[i];;
						mesh.position.y = dude_positions_y[i];
						mesh.position.z = dude_positions_z[i];

	                	scene.add(mesh);
	                	objects.push(mesh);
                	}
				});

            	//legs
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_legs.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/dude/dude_legs.mtl',
				 				function ( object ) {

 					for (var i = 0; i < dude_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(dude_scales[i], dude_scales[i], dude_scales[i]);
	            		mesh.rotation.y = dude_rotations[i];
	            		mesh.position.x = dude_positions_x[i];;
						mesh.position.y = dude_positions_y[i];
						mesh.position.z = dude_positions_z[i];

	                	scene.add(mesh);
	                	objects.push(mesh);
                	}
				});
			}

			function initWindmillPositions() {

				windmill_positions_x.push(400);
				windmill_positions_y.push(0);
				windmill_positions_z.push(450);

				windmill_positions_x.push(400);
				windmill_positions_y.push(0);
				windmill_positions_z.push(300);

				windmill_positions_x.push(400);
				windmill_positions_y.push(0);
				windmill_positions_z.push(150);

				windmill_positions_x.push(400);
				windmill_positions_y.push(0);
				windmill_positions_z.push(0);
			}

			function createWindmills() {

				var loader = new THREE.OBJLoader();

				loader.load( 'http://homepages.ecs.vuw.ac.nz/~remnanjona/M.A.F.I.A/res/windmill_blades.obj', function ( object ) {

                	material = new THREE.MeshPhongMaterial( { specular: 0xffffff, shading: THREE.SmoothShading, vertexColors: THREE.VertexColors } );
                	for (var i = 0; i < windmill_positions_x.length; ++i) {

                		var mesh = object.clone();

                		mesh.scale.set(windmill_scale, windmill_scale, windmill_scale);
                		mesh.rotation.y = -1;
                		mesh.position.x = windmill_positions_x[i];
						mesh.position.y = windmill_positions_y[i] + 6.13328 * windmill_scale;
						mesh.position.z = windmill_positions_z[i];
                    	scene.add( mesh );
                    	blades.push( mesh );
                    	blade_speed.push( Math.random() * 0.2 );

                    	material.color.setHSL( Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
                    	objects.push( mesh );
                	}
                } );

                loader.load( 'http://homepages.ecs.vuw.ac.nz/~remnanjona/M.A.F.I.A/res/windmill_base.obj', function ( object ) {

                	material = new THREE.MeshPhongMaterial( { specular: 0xffffff, shading: THREE.SmoothShading, vertexColors: THREE.VertexColors } );

                	for (var i = 0; i < windmill_positions_x.length; ++i) {

                		var mesh = object.clone();

                		mesh.scale.set(windmill_scale, windmill_scale, windmill_scale);
                		mesh.rotation.y = -1;
                		mesh.position.x = windmill_positions_x[i];
						mesh.position.y = windmill_positions_y[i];
						mesh.position.z = windmill_positions_z[i];
                    	scene.add( mesh );

                    	material.color.setHSL( Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
                    	objects.push( mesh );
                	}

                });
			}

			function initHouse1Positions() {

				house_1_rotations.push(0.0);
				house_1_positions_x.push(-1000);
				house_1_positions_y.push(-40);
				house_1_positions_z.push(400);

				house_1_rotations.push(-0.75);
				house_1_positions_x.push(-400);
				house_1_positions_y.push(-35);
				house_1_positions_z.push(400);

				house_1_rotations.push(-0.25);
				house_1_positions_x.push(-700);
				house_1_positions_y.push(-45);
				house_1_positions_z.push(400);

				house_1_rotations.push(0.0);
				house_1_positions_x.push(0);
				house_1_positions_y.push(0.0);
				house_1_positions_z.push(-200);
			}

			//creates a house 1
			function createHouse1() {

            	var loadermtl = new THREE.OBJMTLLoader();
	
                //body
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_body.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_body.mtl', 
				 				function ( object ) {

 					for (var i = 0; i < house_1_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(house_1_scale, house_1_scale, house_1_scale);
	            		mesh.rotation.y = house_1_rotations[i];
	            		mesh.position.x = house_1_positions_x[i];;
						mesh.position.y = house_1_positions_y[i];
						mesh.position.z = house_1_positions_z[i];

	                	scene.add(mesh);
	                	objects.push(mesh);
                	}
				});

                //base
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_base.obj',
			 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_base.mtl', 
			 				function ( object ) {

 					for (var i = 0; i < house_1_positions_x.length; ++i) {

		                //base
						var mesh = object.clone();

		        		mesh.scale.set(house_1_scale, house_1_scale, house_1_scale);
		        		mesh.rotation.y = house_1_rotations[i];
		        		mesh.position.x = house_1_positions_x[i];
						mesh.position.y = house_1_positions_y[i];
						mesh.position.z = house_1_positions_z[i];

		            	scene.add( mesh );
		            	objects.push( mesh );
	            	}
            	});

                //frames
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_frames.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_frames.mtl', 
				 				function ( object ) {

 					for (var i = 0; i < house_1_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(house_1_scale, house_1_scale, house_1_scale);
	            		mesh.rotation.y = house_1_rotations[i];
	            		mesh.position.x = house_1_positions_x[i];
						mesh.position.y = house_1_positions_y[i];
						mesh.position.z = house_1_positions_z[i];

	                	scene.add( mesh );
	                	objects.push( mesh );
                	}
				});

                //pillars
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_pillars.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_pillars.mtl', 
				 				function ( object ) {

 					for (var i = 0; i < house_1_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(house_1_scale, house_1_scale, house_1_scale);
	            		mesh.rotation.y = house_1_rotations[i];
	            		mesh.position.x = house_1_positions_x[i];
						mesh.position.y = house_1_positions_y[i];
						mesh.position.z = house_1_positions_z[i];

	                	scene.add( mesh );
	                	objects.push( mesh );
                	}
				});

                //roof
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_roof.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_roof.mtl', 
				 				function ( object ) {

 					for (var i = 0; i < house_1_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(house_1_scale, house_1_scale, house_1_scale);
	            		mesh.rotation.y = house_1_rotations[i];
	            		mesh.position.x = house_1_positions_x[i];
						mesh.position.y = house_1_positions_y[i];
						mesh.position.z = house_1_positions_z[i];

	                	scene.add( mesh );
	                	objects.push( mesh );
                	}
				});

                //windows
				loadermtl.load( 'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_windows.obj',
				 				'http://homepages.ecs.vuw.ac.nz/~saxondavi/res/house/house_1_windows.mtl', 
				 				function ( object ) {

 					for (var i = 0; i < house_1_positions_x.length; ++i) {

						var mesh = object.clone();

	            		mesh.scale.set(house_1_scale, house_1_scale, house_1_scale);
	            		mesh.rotation.y = house_1_rotations[i];
	            		mesh.position.x = house_1_positions_x[i];
						mesh.position.y = house_1_positions_y[i];
						mesh.position.z = house_1_positions_z[i];

	                	scene.add( mesh );
	                	objects.push( mesh );
                	}
				});
			}
			
		</script>

	</body>
    <script type="text/javascript">

    // initialize Facebook
    (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=585106381554035";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>
</html>
