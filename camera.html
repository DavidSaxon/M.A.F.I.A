<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>three.js - pointerlock controls</title>

		</style>
	</head>
	<body>
	  	<script src="lib/three.min.js"></script>
		<!--<script src=<"https://rawgithub.com/mrdoob/three.js/master/build/three.min.js"></script>-->
		<script src="js/MTLLoader.js"></script>
		<script src="js/OBJMTLLoader.js"></script>
		<script src="js/OBJLoader.js"></script>
		<script src="js/game/game.js"></script>
		<script src="js/game/item.js"></script>
		<script src="MyPointerLockControls.js"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
		<script type="text/javascript" src="interactions.js"></script>
		<script type="text/javascript" src="constants.js"></script>
		<script src="js/Detector.js"></script>
		<link href='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css' rel='stylesheet' type='text/css'>
		<!--Not sure if we need both these stylesheets or if they will conflict -->
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />			
	
		<link href='stylesheet.css' rel='stylesheet' type='text/css'>

		<div id='hint' style="display:none">
			Walk up to people to talk to them. <br /> [enter]
		</div>


		<div id="blocker">

			<div id="instructions">
				<span style="font-size:40px">Click to play</span>
				<br />
				(W, A, S, D = Move, SPACE = Jump, MOUSE = Look around, Q = Interact, T = Talk)
			<div id="fb-root"></div>
	    		<!--<div class="fb-login-button" autologoutlink="true" scope="publish_stream" data-show-faces="false" data-width="200" data-max-rows="1"></div>-->
			  <div id="share">  
			  <a href="#" 
			      onclick="
				window.open(
				  'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href), 
				  'facebook-share-dialog', 
				  'width=626,height=436'); 
				return false;">
			      Share on Facebook
			    </a>	
			</div>
			<div class="fb-like" data-href="http://homepages.ecs.vuw.ac.nz/~markovmadd/camera.html" data-width="200" data-height="200" data-colorscheme="light" data-layout="standard" data-action="like" data-show-faces="true" data-send="false"></div>
			</div>


		</div>


  <!--This is being used.  Copied from JQuery UI examples -->
		<div id="radio-container">
		  <div id="buttons-instructions">
		   <p> Press the number keys to control the amount of thing.  0 is none; 4 is all.</p>
		   <p> Effects are extrapolated for what would happen if the whole of NZ had this. </p>
		   </div>
			     <p style="color:blue">Press M to get more information.</p>
		<form>
		<div id="radio">
		<input type="radio" id="radio0" name="radio" /><label for="radio0">None</label>
		<input type="radio" id="radio1" name="radio" /><label for="radio1">A little</label>
		<input type="radio" id="radio2" name="radio" checked="checked" /><label for="radio2">Some</label>
		<input type="radio" id="radio3" name="radio" /><label for="radio3">Most</label>
		<input type="radio" id="radio4" name="radio" /><label for="radio4">All</label>
		</div>
		</form>
		</div>

		<div id="dialogue-box">
		    <div id="dialogue-text">Help us!</div>
		</div>


		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var camera, scene, renderer;
			var geometry, material, mesh;
			var controls,time = Date.now();
// 
			var objects = [];
			var blades = [];	// just to rotate on update

			var ray;

			var blocker = document.getElementById( 'blocker' );
			var instructions = document.getElementById( 'instructions' );

			var game = new game();

			//Keep the blocker div from disappearing when the user clicks the Facebook share link
			share.addEventListener( 'click', function ( event ) {
			  event.stopPropagation();
			});
			// http://www.html5rocks.com/en/tutorials/pointerlock/intro/

			var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

			if ( havePointerLock ) {

				var element = document.body;

				var pointerlockchange = function ( event ) {

					if ( document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element ) {

						controls.enabled = true;

						blocker.style.display = 'none';

					} else {

						controls.enabled = false;

						blocker.style.display = '-webkit-box';
						blocker.style.display = '-moz-box';
						blocker.style.display = 'box';

						instructions.style.display = '';

					}

				}

				var pointerlockerror = function ( event ) {

					instructions.style.display = '';

				}

				// Hook pointer lock state change events
				document.addEventListener( 'pointerlockchange', pointerlockchange, false );
				document.addEventListener( 'mozpointerlockchange', pointerlockchange, false );
				document.addEventListener( 'webkitpointerlockchange', pointerlockchange, false );

				document.addEventListener( 'pointerlockerror', pointerlockerror, false );
				document.addEventListener( 'mozpointerlockerror', pointerlockerror, false );
				document.addEventListener( 'webkitpointerlockerror', pointerlockerror, false );

				instructions.addEventListener( 'click', function ( event ) {

					instructions.style.display = 'none';

					// Ask the browser to lock the pointer
					element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

					if ( /Firefox/i.test( navigator.userAgent ) ) {

						var fullscreenchange = function ( event ) {

							if ( document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element ) {

								document.removeEventListener( 'fullscreenchange', fullscreenchange );
								document.removeEventListener( 'mozfullscreenchange', fullscreenchange );

								element.requestPointerLock();
							}

						}

						document.addEventListener( 'fullscreenchange', fullscreenchange, false );
						document.addEventListener( 'mozfullscreenchange', fullscreenchange, false );

						element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

						element.requestFullscreen();

					} else {

						element.requestPointerLock();

					}

				}, false );

			} else {

				instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

			}

			// NOTE: animate() was moved to be inside the init() function to fix the error that
			// where water isn't loaded in animate yet
			init();

			function init() {
				initInteractions(); //Call to interactions.js library (located in js if you want to modify it, but hosted on my homepages
							  //currently -Maddy

				//$( "#dialogue-box").toggle("fold");
				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1000 );

				scene = new THREE.Scene();
				scene.fog = new THREE.Fog( 0xffffff, 0, 1500 );

				var light = new THREE.DirectionalLight( 0xffffff, 1.5 );
				light.position.set( 1, 1, 1 );
				scene.add( light );

				var light = new THREE.DirectionalLight( 0x88aaaa, 0.75 );
				light.position.set( -1, - 0.5, -1 );
				scene.add( light );

				controls = new THREE.PointerLockControls( camera );
				scene.add( controls.getObject() );

				ray = new THREE.Raycaster();
				ray.ray.direction.set( 0, -1, 0 );

				// sea
				 var loader = new THREE.ImageLoader( );
                loader.load( 'res/water.jpg', function ( image ) {

                	var texture = new THREE.Texture();
                    texture.image = image;
                    texture.needsUpdate = true;

                   	geometry = new THREE.PlaneGeometry( 2000, 2000, 100, 100 );
					geometry.applyMatrix( new THREE.Matrix4().makeRotationX( - Math.PI / 2 ) );

					for ( var i = 0, l = geometry.vertices.length; i < l; i ++ ) {

						var vertex = geometry.vertices[ i ];
						vertex.x += Math.random() * 20 - 10;
						vertex.y += Math.random() * 5;
						vertex.z += Math.random() * 20 - 10;

					}

                    material  = new THREE.MeshLambertMaterial({
  						map           : texture,
 						vertexColors  : THREE.VertexColors,
 						transparent: true, 
 						opacity: 0.9
 					} );

 					water = new THREE.Mesh( geometry, material );
					scene.add( water );

					animate();
			
				});

                //TERRAIN
                createTerrain();

                //DUDE
                initDudePositions();
                var dudeParts = ['res/dude/dude_eyes',
                			'res/dude/dude_face',
                			'res/dude/dude_top',
                			'res/dude/dude_legs'];
                loadObjMtlList("dude", dudeParts);


                //WINDMILL
                initWindmillPositions();
                createWindmills();

            	//HOUSE
            	initHouse1Positions();
            	var houseParts = ['res/house/house_1_body',
            				'res/house/house_1_base',
            				'res/house/house_1_frames',
            				'res/house/house_1_pillars',
            				'res/house/house_1_roof',
            				'res/house/house_1_windows'];
            	loadObjMtlList("house", houseParts);	
            	


				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.setClearColorHex( 0xaaffff, 1 );

				document.body.appendChild( renderer.domElement );


				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );

				//

				controls.isOnObject( false );

				ray.ray.origin.copy( controls.getObject().position );
				ray.ray.origin.y -= 10;

				var intersections = ray.intersectObjects( objects );

				if ( intersections.length > 0 ) {

					var distance = intersections[ 0 ].distance;

					if ( distance > 0 && distance < 10 ) {

						controls.isOnObject( true );

					}

				}

				// update game state
				game.update();

				// rotate all the blades
				var list = game.getAll("windmill");
				for (var i = 0; i < list.length; i++) {
					blades[i].rotation.z += list[i].bladeSpeed;
				}

				// update sea level
				water.position.y = game.seaLevel;

				// check collisions
				var ps = controls.getObject().position;
				var nearthing = game.checkCollision(ps);
				//console.log(nearthing);
				interactWith(nearthing);

				controls.update( Date.now() - time );
				if(toggle){
					$( "#test" ).toggle( "fold" );
					toggle = false;
				}

				renderer.render( scene, camera );


				time = Date.now();

			}



			//creates the terrain
			function createTerrain() {

        	var loadermtl = new THREE.OBJMTLLoader();

                //terrain
				loadermtl.load( 'res/terrain/terrain.obj',
	 				'res/terrain/terrain.mtl', 
	 				function ( object ) {

 					scene.add( object );
                	objects.push( object );
				});
			}

			function initDudePositions() {

				game.add( new dude(0, 0, -140, 12) );
				game.add( new dude(20, 5, -160, 7) );
				game.add( new dude(30, 5, -160, 10) );

			}

			function loadObjMtlList(gameObjString, fileList) {
				var loadermtl = new THREE.OBJMTLLoader();

				for (var i = 0; i < fileList.length; ++i) {
					var objName = fileList[i]+'.obj';
					var mtlName = fileList[i]+'.mtl';

					loadermtl.load( objName, mtlName, function ( object ) {

				 		/* use games list of all the things */
                		var list = game.getAll(gameObjString);

 						for (var i = 0; i < list.length; ++i) {

							var mesh = object.clone();

	            			mesh.scale.set(list[i].scalesize, list[i].scalesize, list[i].scalesize);
	            			mesh.rotation.y = list[i].yRot;
	            			mesh.position= list[i].position;

	                		scene.add(mesh);
	                		objects.push(mesh);
                		}
					});
				}
			}

			function initWindmillPositions() {

				game.add( new windmill(400, 0, 450) );
				game.add( new windmill(400, 0, 300) );
				game.add( new windmill(400, 0, 150) );
				game.add( new windmill(400, 0, 0) );

			}

			/* load windmills into positions specified by game logic */
			function createWindmills() {
				var loader = new THREE.OBJLoader();

				loader.load( 'res/windmill_blades.obj', function ( object ) {
                	material = new THREE.MeshPhongMaterial( { specular: 0xffffff, shading: THREE.SmoothShading, vertexColors: THREE.VertexColors } );

                	/* use games list of windmills */
                	var list = game.getAll("windmill");
                	for (var i = 0; i < list.length; ++i) {

                		var mesh = object.clone();

                		mesh.scale.set(list[i].scalesize, list[i].scalesize, list[i].scalesize);
                		mesh.rotation.y = -1;
                		mesh.position = list[i].position.clone();
                		mesh.position.y += 6.13328 * list[i].scalesize;

                    	scene.add( mesh );
                    	blades.push( mesh );

                    	material.color.setHSL( Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
                    	objects.push( mesh );
                	}
                } );

                loader.load( 'res/windmill_base.obj', function ( object ) {
                	material = new THREE.MeshPhongMaterial( { specular: 0xffffff, shading: THREE.SmoothShading, vertexColors: THREE.VertexColors } );

                	/* use games list of windmills */
                	var list = game.getAll("windmill");
                	for (var i = 0; i < list.length; ++i) {

                		var mesh = object.clone();

                		mesh.scale.set(list[i].scalesize, list[i].scalesize, list[i].scalesize);
                		mesh.rotation.y = -1;
                		mesh.position = list[i].position.clone();

                    	scene.add( mesh );
                    	material.color.setHSL( Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
                    	objects.push( mesh );
                	}

                });
			}

			function initHouse1Positions() {
				game.add( new house(-1000, -40, 400, 0.0) );
				game.add( new house(-400, -35, 400, -0.75) );
				game.add( new house(-700, -45, 400, -0.25) );
				game.add( new house(0, 0, -200, 0.0) );
			}
			
		</script>

	</body>
    <script type="text/javascript">

    // initialize Facebook
    (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)){ return;}
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=585106381554035";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>

</html>
